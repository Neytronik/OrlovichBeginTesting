var CSRF={counter:0,tokens:[],storeTokens:[],user:null,requests:[],init:function(tokens,user){var self=this;if(tokens&&tokens.length){self.tokens=tokens;self.log(['Юзеру выданы токены:',tokens]);}else{self.log(['Юзеру не выданы токены']);}
if(user){self.user=user;}},push:function(token){var self=this;self.tokens.push(token);},addRequest:function(request){var self=this;self.requests.push(request);},log:function(message){var self=this;var date=self.showTime(new Date());console.log('___');console.log('%c'+date,'color:green;');for(var i=0;i<message.length;i++){console.log(message[i]);}},showTime:function(date){var self=this;var out=(date.getHours()<10?'0':'')+date.getHours()+":"+
(date.getMinutes()<10?'0':'')+date.getMinutes()+":"+
(date.getSeconds()<10?'0':'')+date.getSeconds();return out;},sendRequest:function(request,isAjax){var self=this;self.addRequest(request);var token='nofreetokensleft';if(self.tokens&&self.tokens.length){var storeToken=self.tokens[0];self.storeTokens.push(storeToken);token=self.tokens.shift();}
self.counter++;var req;if(isAjax){req=new CSRFAjaxRequest(request,token,self.counter);}else{req=new CSRFRequest(request,token,self.counter);}
req.init();if(!isAjax){return req.RequestN;}},RequestN:0};function CSRFRequest(request,token,counter){var self=this;self.request=request;self.token=token;self.counter=counter;}
CSRFRequest.prototype={init:function(){var self=this;CSRF.log([self.counter+': отправляем новый запрос',self.request]);self.sendRequest();},sendRequest:function(){var self=this;if(!self.request.params){self.request.params={};}
self.request.params.csrf=self.token;if(!self.request.OnData&&!self.request.OnHTML){self.request.OnData=function(data){};}
if(self.request.OnData||self.request.OnHTML){var response;var fail;var msg;if(self.request.OnData){response=self.request.OnData;fail=self.request.OnDataFail;msg='ok';self.request.OnData=function(data){self.responseFunction(data,msg,response);};self.request.OnDataFail=function(data){self.responseFunction(data,msg,fail);};}else if(self.request.OnHTML){response=self.request.OnHTML;fail=self.request.OnHTMLFail;msg='error';self.request.OnHTML=function(data){self.responseFunction(data,msg,response);};self.request.OnHTMLFail=function(data){self.responseFunction(data,msg,fail);};}}
self.RequestN=GUJ.PutRequest(self.request);},responseFunction:function(data,msg,response){var self=this;if(response){response(data);CSRF.log([self.counter+': пришел ответ ('+msg+') с сервера:',data]);}
var csrf=data.csrf||(data.dataset&&data.dataset.csrf);if(!csrf){CSRF.log([self.counter+': не получен csrf токен из ответа ('+msg+'):',data]);}
if(csrf&&/(неверный csrf|csrf неверный|csrf просрочен)/ig.test(data.error_msg)){CSRF.log([self.counter+': получили сообщение ('+data.error_msg+') с сервера, нужно повторить запрос']);self.retry(csrf);}else{self.update(csrf);}},update:function(token){var self=this;if(token){CSRF.push(token);CSRF.log([self.counter+': получили новый токен:',token]);}},retry:function(token){var self=this;if(token){CSRF.log([self.counter+': получили новый токен:',token]);CSRF.storeTokens.push(csrf);self.token=token;CSRF.log([self.counter+': повторется запрос',self.request]);self.sendRequest();}}};function CSRFAjaxRequest(request,token,counter){CSRFRequest.call(this,request,token,counter);}
CSRFAjaxRequest.prototype=Object.create(CSRFRequest.prototype);CSRFAjaxRequest.prototype.sendRequest=function(){var self=this;if(!self.request.data){var formData=new FormData();self.request.data=formData;}
self.request.data.append('csrf',self.token);if(self.request.success){var response;var fail;var msg;if(self.request.success){response=self.request.success;fail=self.request.error;msg='ok';self.request.success=function(data){self.responseFunction(data,msg,response);};self.request.error=function(data){self.responseFunction(data,msg,fail);};}}
$.ajax(self.request);};