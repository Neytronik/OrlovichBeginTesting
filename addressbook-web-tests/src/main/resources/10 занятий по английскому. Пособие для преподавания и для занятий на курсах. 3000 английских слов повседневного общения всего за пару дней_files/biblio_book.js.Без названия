function LastViewed(artID){var data=getCookie("last_viewed");var dataArr=new Array();var MaxQueueLen=30;if(data){dataArr=data.split(',');if(dataArr.indexOf(artID+"")!=-1)return;}
dataArr.push(artID);if(dataArr.length>MaxQueueLen){dataArr.splice(0,1);}
setCookie("last_viewed",dataArr,6,"/");}
BodyEndFunc.push({'biblio_book_annot_resize':function(){if($('.book_annotation').length&&$('#blockcenter').length&&$('#book-cover').length&&$('.book_annotation.adult').length==0){if(($('.book_annotation').height()+16)>=($('#book-cover').height()-$('#blockcenter').height())){$('.book_annotation').css('display','inline-block');$('.book_annotation').addClass('make_inline-block');}}else if($('.book_annotation.adult').length){function book_annotation_hide(){$('.book_annotation.adult').html('<p class="warning">Аннотация скрыта.</p>');}
setTimeout(book_annotation_hide,100);}}});BodyEndFunc.push({'adult-user':function(){if($('.adult-user-date input').length){$('.adult-user-date input').live('keyup',function(){if($(this).val().length==2){$(this).parent().next().find('input').focus();}else if($(this).val().length==4){$(this).parent().parent().next().focus()}});}}});BodyEndFunc.push({'biblio_book_resize':function(){function reSize(){if($('.book-price-wrapper').length)return false;var win_width=$(window).width(),span_1024=$('.span_1024'),rbook_cover=$('#readers-info #book-cover'),rright_block=$('#readers-info .right-block');if(win_width<1024){span_1024.hide();$('.span_1024_rub').html(' <span class="litres_ruble">&#8381;</span>');$('.book-info2').css('width','100%');$('.span_1024_preorder').html('Предзаказ');$('.make_inline-block').css('width','100%');rbook_cover.before(rright_block);rright_block.css('margin-left',0);}else{span_1024.show();$('.span_1024_rub').html(' <span class="litres_ruble">&#8381;</span>');$('.book-info2').css('width','70%');$('#reg_buynow').find('.span_1024_preorder').html('Сделать предзаказ');$('.make_inline-block').css('width','80%');rright_block.before(rbook_cover);rright_block.css('margin-left',463+'px');}}
if($('#reader-wrap').length){$('#reader-wrap').show();}
$(document).ready(function(){$(window).bind('resize',reSize());$(window).trigger('resize()');});var FixSize_T;WinResizeFunc.push({'reSize':function(){clearTimeout(FixSize_T);FixSize_T=setTimeout(reSize,200);}});if($('#reader_text').height()>96){$('#reader_text').css('height',96+'px').append('<div class="fring"></div>').after('<a id="show_more" href="javascript:void(0);"><span>Развернуть описание</span></a>');$('a#show_more').click(function(){$("#reader_text").animate({'height':'100%'});$("#reader_descr").addClass("open");$("#show_more").remove();});}
$('#reader-preview .case').click(function(){var newval=$(this).find('img').attr('src').match(/(\S+)\_89\.jpg/)[1];$('.readerpage-left div img:not(".cover_img")').attr('src',newval+'_250.jpg');var newheight=Math.ceil(250*$(this).find('img').attr('height')/$(this).find('img').attr('width'));if(newheight>390)newheight=390;var newwidth=newheight<390?250:Math.ceil(newheight*$(this).find('img').attr('width')/$(this).find('img').attr('height'));$('.readerpage-left div img').attr({'height':newheight,'width':newwidth});staticval='/static'+newval.split('static')[1];var bigimage=new Image();var imgid=$('.readerpage-left div img.cover_img').attr('id');Slides[imgid]['big_src']=staticval+".jpg";Slides[imgid]['big_img']='<img src="'+Slides[imgid]['big_src']+'">';bigimage.onload=function(){var imgwidth=bigimage.width;var imgheight=bigimage.height;if(imgwidth>250){$('.readerpage-left div img[id^=cover_img]').show();Slides[imgid]['imgsize']={sw:newwidth,sh:newheight,bw:imgwidth,bh:imgheight};}else{$('.readerpage-left div img[id^=cover_img]').hide();}}
bigimage.src=Slides[imgid]['big_src'];$('.readerpage-left .cover_div').css({'height':newheight});$('#reader-preview .case').removeClass('highlight');$(this).addClass('highlight');});if($('#reader-preview').height()>$('#reader-wrap').height()){$('#reader-wrap').append('<div id="reader-top"><div class="reader-arrow"></div></div><div id="reader-bottom"><div class="reader-arrow"></div></div>');tpos=$('#reader-preview').position().top;step=100;hpos=tpos;$('#reader-top').click(function(){if(Math.ceil($('#reader-preview').position().top)<0){if(Math.ceil($('#reader-preview').position().top+step)<0){$('#reader-bottom').show();var stepup=Math.ceil($('#reader-preview').position().top)+step;$('#reader-preview').animate({"top":stepup+'px'},500);hpos+=step;}else{$('#reader-preview').animate({"top":0+'px'},500);$('#reader-top').hide();hpos=0;}}else{$('#reader-preview').css({'top':0});$('#reader-top').hide();hpos=0;}
$('#reader-bottom').show();});$('#reader-bottom').click(function(){if(Math.ceil($('#reader-preview').position().top)<=0){if(Math.ceil($('#reader-preview').position().top-step)>tpos&&hpos>tpos){var stepdown=Math.ceil($('#reader-preview').position().top)-step;$('#reader-preview').animate({"top":stepdown+'px'});}else{$('#reader-preview').animate({"top":tpos+'px'},500);$('#reader-bottom').hide();hpos=tpos;}
$('#reader-top').show();}else{$('#reader-preview').css({'top':tpos-1});$('#reader-bottom').hide();hpos=tpos;}
$('#reader-top').show();});}
if($('.show_tomorrow').length){var nowdate=new Date($('.show_tomorrow').text());nowdate.setDate(nowdate.getDate()+1);var tomorrowmonth=nowdate.getMonth()
var tomorrowday=nowdate.getDate();$('.show_tomorrow').html(', '+tomorrowday+' '+RusMonth(tomorrowmonth)).show();}
if($('.show_delivery').length){var nowdate=new Date($('.show_delivery').text());nowdate.setDate(nowdate.getDate()+10);var tomorrowmonth=nowdate.getMonth()
var tomorrowday=nowdate.getDate();$('.show_delivery').before(': ').html('<span>примерно, '+tomorrowday+' '+RusMonth(tomorrowmonth)+'</span>').show();}}});BodyEndFunc.push({'biblio_book_feedback':function(){$(document).ready(function(){if($('.question_form input[type=submit]').length){$('.question_form input[type=submit]').live('click',function(){var name=$('input[name=name]:gt(0)').val();var phone=$('input[name=phone]:gt(0)').val();var other=$('input[name=other]:gt(0)').val();var comment=$('textarea[name=comment]:gt(0)').val();if(!(phone!=''||other!='')){alert("Пожалуйста, заполните Ваши контактные данные");return false;}else if(comment==''){alert("Поле 'Комментарий' не должно быть пустым");return false;}
$('img[name=feedback_loading]').show();var Request={url:'/pages/ajax_epmty/',OnData:function(Data){$('img[name=feedback_loading]').hide();if(Data=='ok'){$('#hg-pop_close').click();alert("Ваше сообщение отправлено.\nНаш менеджер свяжется с Вами в ближайшее время");}else{alert("Произошла ошибка при отправке сообщения. "+Data[0]);}},params:{action:'ajax_reader_feedback',name:name,phone:phone,other:other,comment:comment}};GUJ.PutRequest(Request);return false;});}});}});BodyEndFunc.push({'biblio_book_ade':function(){$('#ade_support_check, #ade_support_check2').click(function(){$('#span_drm_link, #span_drm_link_text').show();$('#ADE_UnsupportedOSDiv, #ADE_NeedADEWarning').hide();});}});BodyEndFunc.push({'show-txt':function(){if($('#show-annot-book').length){$('#show-annot-book').css('height','95px');$('<div class="show"><span class="shadow"></span><a><span>Развернуть отрывок</span></a></div>').appendTo('.show-content-txt');$('#show-annot-book .show').live('click',function(){$(this).parent().addClass('show-content-txt-active');$(this).remove();});}}});function AudioPreviewPlay(){$('.audio_preview').hide().next().show();setTimeout(function(){$('#jquery_jplayer_1').jPlayer('play');},'200');}
BodyEndFunc.push({'datepicker':function(){if($('#ui-date').length){var month_str=['января','февраля','марта','апреля','мая','июня','июля','августа','сентября','октября','ноября','декабря'];$('#ui-date input').datepicker({showOn:"button",buttonImage:"/static/new/i/date.png",buttonImageOnly:true,numberOfMonths:2,maxDate:'+35M +30D',minDate:'+14',dateFormat:'yy-mm-dd'});$("#ui-date input").datepicker('setDate','+10D');$('#ui-date input').change(function(){var v_data=$(this).val().split('-');$(this).parent().next("#ui-date-number").html(parseInt(v_data[2],10)+" "+month_str[v_data[1]-1]+" "+v_data[0]);}).change();$('#ui-date-number').click(function(){$(this).prev().find('input').datepicker("show");$('#ui-datepicker-div').css({'left':$('#ui-date').offset().left-300+'px','top':$('#ui-date').offset().top+32+'px'});DatePickerTop($('#ui-datepicker-div'));});$('#ui-date img').click(function(){$('#ui-datepicker-div').css({'left':$('#ui-date').offset().left-300+'px','top':$('#ui-date').offset().top+32+'px'});DatePickerTop($('#ui-datepicker-div'));});function DatePickerTop(el){var dp_height=$('#ui-datepicker-div').height(),dp_offset=parseInt($('#ui-datepicker-div').offset().top+dp_height);if(dp_offset>$(window).height())
el.css({top:$('.input.inp_date').offset().top-dp_height-5+'px'});}}}});function SubmitSentEmail(){var email=document.mark_to_ibs_form.mail.value;if(MailOK(email)==0){alert("Электронную почту необходимо указывать в правильном формате, например: ivan.ivanovich@litres.ru\n\n");return false;}else if(MailOK(email)==1){alert("Вы не указали свой e-mail! Зайдите в настройки своего аккаунта (в правом верхнем углу) и укажите свой e-mail.\n\n");return false;}else{document.mark_to_ibs_form.submit();}}
function PollForDRM(art){if(!/^\d+$/.test(art))return;var Request={url:'/pages/ajax_check_drm/',OnData:function(Data){if(Data.status=='url_delivered'){jQuery('#download_ok').remove();jQuery('.drmbox').show();return;}else if(Data.status=='pending_url'){setTimeout("PollForDRM("+art+")",5000);return;}else{alert("При доставке файла вашей книги произошла ошибка.");return;}},params:{art:art,rand:Math.random()}};GUJ.PutRequest(Request);return;}
function SelAvatar(id,img){window.opener.document.getElementById('avatar_img').src='/static/users/'+img;window.opener.document.getElementById('avatar_id').value=img;window.opener.document.getElementById('id_avatar').value=id;self.close();}
BodyEndFunc.push({'read_book_online':function(){if($('#onlineread').length){function applyFontsize(fontsize){$('.online_reading').css('font-size',fontsize+'px');}
var min_fontsize=12;var max_fontsize=20;var default_fontsize=16;var fontsize_step=1;var fontsize=current_fontsize||parseInt(getCookie('onlineread_fontsize'))||default_fontsize;if(fontsize!=default_fontsize&&fontsize>=min_fontsize&&fontsize<=max_fontsize&&!current_fontsize){applyFontsize(fontsize);}
var $font_controls=$('.increaseFont, .decreaseFont').click(function(){var new_fontsize=$(this).hasClass('increaseFont')?fontsize+fontsize_step:fontsize-fontsize_step;if(new_fontsize>=min_fontsize&&new_fontsize<=max_fontsize){fontsize=new_fontsize;applyFontsize(fontsize);setCookie('onlineread_fontsize',fontsize,60);$font_controls.removeClass('disabled');}
if(new_fontsize>=max_fontsize){$('.increaseFont').addClass('disabled');}
if(new_fontsize<=min_fontsize){$('.decreaseFont').addClass('disabled');}
return false;});function hideNotes(){$('.online_reading .note.active').removeClass('active');$('.online_reading .footnote').removeClass('current');}
$('.online_reading .footnote').click(function(){var $this=$(this);var position=$this.position();var $note=$($this.attr('href'));$this.toggleClass('current');$note.toggleClass('active').css({left:position.left,top:position.top});return false;});$('html').click(function(){hideNotes();});$('.online_reading .note').click(function(e){e.stopPropagation();});}}});BodyEndFunc.push({'app-read':function(){$('.ar-show-form').on('click',function(){$('#ar-form').show();$('#ar-txt').hide();});}});function SendOtpin(art){var val=$('#app-read-data').val(),txt=$('#app-type'),Request={url:'/pages/ajax_send_otpin/',Method:'POST',OnData:function(data){if(data.status=='ok'){if(data.type=='email'){txt.text('e-mail');}else{txt.text('телефон');}
$('#app-value').text(val);$('#ar-form').hide();$('#ar-txt').show();}
else{alert(data.err);}},params:{email_or_phone:val,art:art}};if(MailOK(val)!=2&&ValidatePhone(val)!=1){alert('Произошла ошибка. Пожалуйста, проверьте введенные данные');}else{GUJ.PutRequest(Request);}
return false;}
BodyEndFunc.push({'readframe':function(){var ov=$("#readframe-bubble"),b=$('body'),w=b.width()-60;if(ov.length){ov.width(w);ov.overlay({speed:100,mask:{color:'#000',loadSpeed:200,opacity:0.7},fixed:true,onLoad:function(){window.location.hash='readframe';hash_frame=true;},onClose:function(){if(hash_frame){history.go(-1);}}});$(window).resize(function(){var wh=$(window).height()-60-50,w=$('body').width()-60;ov.width(w).find('iframe').css('height',wh);});}}});function ReadFrame(trial){var ov=$("#readframe-bubble"),b=$('body'),h=b.height()-60-50;b.addClass('no-scroll');var w=b.width()-60;ov.width(w).data("overlay").load();ov.find('iframe').css('height',h).attr('src',trial);$('#livechat-compact-container').hide();$('#ab-header').css('zIndex',9990);}
function CloseReadFrame(){$("#readframe-bubble").data("overlay").close();$('body').removeClass('no-scroll');$('#livechat-compact-container').show();$('#ab-header').css('zIndex',9999);}
jQuery(document).on('yacounter2199583inited',function(){var bc=$("#blockcenter");if(bc.attr('data-purchased')!=1){yaCounter2199583.reachGoal('old_bookpage');}
if(bc.attr('data-test')==161){yaCounter2199583.reachGoal('v_1');}else{yaCounter2199583.reachGoal('v_2');}});
